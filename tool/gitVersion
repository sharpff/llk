#!/bin/bash

CMD_NAME=$(echo $0 | sed 's,^\(.*/\)\?\([^/]*\),\2,')
DIR_NAME=$(basename $(pwd))
BRANCH_NAME=$(git branch --no-color 2> /dev/null | sed -e '/^[^*]/d' -e "s/* \(.*\)/\1/")
GIT_VERSION=$(git describe $BRANCH_NAME 2> /dev/null) # must have tag.
if [ $? != 0 ]; then
    GIT_VERSION=g$(git rev-parse --short=7 HEAD)
    if [ $? != 0 ]; then
        echo "The directory isn't controled by git!"
        GIT_VERSION="NotInGit"
    fi
    GIT_VERSION=${GIT_VERSION:1}
fi
if [ $GIT_VERSION != "NotInGit" ]; then
    GIT_STATE=$(git status 2> /dev/null | tail -n1)
    echo $GIT_STATE
    if [[ $GIT_STATE =~ nothing.to.commit.* ]]; then
        BRANCH_STATE="0"
    else
        BRANCH_STATE="1"
    fi
fi

echo -e "/*\n *Auto-generated by $CMD_NAME(Author: feiguoyou@hotmail.com), Don't Modify it!\n */" \
    > $2

sed -e "s/\\""\$WCREV\\""\$/$GIT_VERSION/g" \
    -e "s/\\""\$WCMODS\\""\$/$BRANCH_STATE/g" \
    -e "s/\\""\$WCREV\\""\$/$GIT_VERSION/g" \
    $1 >> $2

